{"version":3,"sources":["../../../../src/commands/run/ios/XcodeBuild.ts"],"names":["getProjectBuildSettings","xcodeProject","configuration","sdkName","scheme","args","isWorkspace","name","Log","debug","join","stdout","stdio","JSON","parse","error","warn","message","match","log","chalk","dim","getAppBinaryPath","buildOutput","CONFIGURATION_BUILD_DIR","extractEnvVariableFromBuild","sort","a","b","length","UNLOCALIZED_RESOURCES_FOLDER_PATH","path","variableName","reg","RegExp","matched","matchAll","CommandError","map","value","filter","Boolean","getProcessOptions","packager","shouldSkipInitialBundling","terminal","port","SKIP_BUNDLING","undefined","env","process","RCT_TERMINAL","RCT_METRO_PORT","toString","RCT_NO_LAUNCH_PACKAGER","logPrettyItem","whiteBright","buildAsync","projectRoot","device","isSimulator","udid","developmentTeamId","push","bold","formatter","ExpoLogFormatter","Promise","resolve","reject","buildProcess","errorOutput","on","data","stringData","lines","pipe","line","stderr","Buffer","code","finish","logFilePath","writeBuildLogs","wasErrorPresented","errors","errorTitle","underline","output","getErrorLogFilePath","fs","writeFileSync","filename","folder","ensureDirSync"],"mappings":"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","sourcesContent":["import spawnAsync from '@expo/spawn-async';\nimport chalk from 'chalk';\nimport { spawn, SpawnOptionsWithoutStdio } from 'child_process';\nimport * as fs from 'fs-extra';\nimport * as path from 'path';\nimport { SimControl } from 'xdl';\n\nimport CommandError from '../../../CommandError';\nimport Log from '../../../log';\nimport { ExpoLogFormatter } from './ExpoLogFormatter';\nimport { ensureDeviceIsCodeSignedForDeploymentAsync } from './developmentCodeSigning';\nimport { ProjectInfo, XcodeConfiguration } from './resolveOptionsAsync';\n\nexport type BuildProps = {\n  projectRoot: string;\n  isSimulator: boolean;\n  xcodeProject: ProjectInfo;\n  device: Pick<SimControl.XCTraceDevice, 'name' | 'udid'>;\n  configuration: XcodeConfiguration;\n  shouldSkipInitialBundling: boolean;\n  shouldStartBundler: boolean;\n  terminal?: string;\n  port: number;\n  scheme: string;\n};\n\ntype XcodeSDKName = 'iphoneos' | 'iphonesimulator';\n\nexport async function getProjectBuildSettings(\n  xcodeProject: ProjectInfo,\n  configuration: XcodeConfiguration,\n  sdkName: XcodeSDKName,\n  scheme: string\n) {\n  const args = [\n    xcodeProject.isWorkspace ? '-workspace' : '-project',\n    xcodeProject.name,\n    '-scheme',\n    scheme,\n    '-sdk',\n    sdkName,\n    // getPlatformName(buildOutput),\n    '-configuration',\n    configuration,\n    '-showBuildSettings',\n    '-json',\n  ];\n  Log.debug(`  xcodebuild ${args.join(' ')}`);\n  const { stdout } = await spawnAsync('xcodebuild', args, { stdio: 'pipe' });\n  try {\n    return JSON.parse(stdout);\n  } catch (error) {\n    // This can fail if the xcodebuild command throws a simulator error:\n    // 2021-01-24 14:22:43.802 xcodebuild[73087:14664906]  DVTAssertions: Warning in /Library/Caches/com.apple.xbs/Sources/DVTiOSFrameworks/DVTiOSFrameworks-17705/DTDeviceKitBase/DTDKRemoteDeviceData.m:371\n    Log.warn(error.message);\n    if (error.message.match(/in JSON at position/)) {\n      Log.log(chalk.dim(stdout));\n    }\n    return {};\n  }\n}\n\n/**\n *\n * @returns '/Users/evanbacon/Library/Developer/Xcode/DerivedData/myapp-gpgjqjodrxtervaufttwnsgimhrx/Build/Products/Debug-iphonesimulator/myapp.app'\n */\nexport function getAppBinaryPath(buildOutput: string) {\n  // Matches what's used in \"Bundle React Native code and images\" script.\n  // Requires that `-hideShellScriptEnvironment` is not included in the build command (extra logs).\n\n  // Like `\\=/Users/evanbacon/Library/Developer/Xcode/DerivedData/Exponent-anpuosnglkxokahjhfszejloqfvo/Build/Products/Debug-iphonesimulator`\n  const CONFIGURATION_BUILD_DIR = extractEnvVariableFromBuild(\n    buildOutput,\n    'CONFIGURATION_BUILD_DIR'\n  ).sort(\n    // Longer name means more suffixes, we want the shortest possible one to be first.\n    // Massive projects (like Expo Go) can sometimes print multiple different sets of environment variables.\n    // This can become an issue with some\n    (a, b) => a.length - b.length\n  );\n  // Like `Exponent.app`\n  const UNLOCALIZED_RESOURCES_FOLDER_PATH = extractEnvVariableFromBuild(\n    buildOutput,\n    'UNLOCALIZED_RESOURCES_FOLDER_PATH'\n  );\n  return path.join(\n    // Use the shortest defined env variable (usually there's just one).\n    CONFIGURATION_BUILD_DIR[0],\n    // Use the last defined env variable.\n    UNLOCALIZED_RESOURCES_FOLDER_PATH[UNLOCALIZED_RESOURCES_FOLDER_PATH.length - 1]\n  );\n}\n\nfunction extractEnvVariableFromBuild(buildOutput: string, variableName: string) {\n  // Xcode can sometimes escape `=` with a backslash or put the value in quotes\n  const reg = new RegExp(`export ${variableName}\\\\\\\\?=(.*)$`, 'mg');\n  const matched = [...buildOutput.matchAll(reg)];\n\n  if (!matched || !matched.length) {\n    throw new CommandError(\n      `Malformed xcodebuild results: \"${variableName}\" variable was not generated in build output. Please report this issue and run your project with Xcode instead.`\n    );\n  }\n  return matched.map(value => value[1]).filter(Boolean) as string[];\n}\n\nfunction getProcessOptions({\n  packager,\n  shouldSkipInitialBundling,\n  terminal,\n  port,\n}: {\n  packager: boolean;\n  shouldSkipInitialBundling?: boolean;\n  terminal: string | undefined;\n  port: number;\n}): SpawnOptionsWithoutStdio {\n  const SKIP_BUNDLING = shouldSkipInitialBundling ? '1' : undefined;\n  if (packager) {\n    return {\n      env: {\n        ...process.env,\n        RCT_TERMINAL: terminal,\n        SKIP_BUNDLING,\n        RCT_METRO_PORT: port.toString(),\n      },\n    };\n  }\n\n  return {\n    env: {\n      ...process.env,\n      RCT_TERMINAL: terminal,\n      SKIP_BUNDLING,\n      // Always skip launching the packager from a build script.\n      // The script is used for people building their project directly from Xcode.\n      // This essentially means \"› Running script 'Start Packager'\" does nothing.\n      RCT_NO_LAUNCH_PACKAGER: 'true',\n      // FORCE_BUNDLING: '0'\n    },\n  };\n}\n\nexport function logPrettyItem(message: string) {\n  Log.log(`${chalk.whiteBright`\\u203A`} ${message}`);\n}\n\nexport async function buildAsync({\n  projectRoot,\n  xcodeProject,\n  device,\n  configuration,\n  isSimulator,\n  scheme,\n  shouldSkipInitialBundling,\n  terminal,\n  port,\n}: BuildProps): Promise<string> {\n  const args = [\n    xcodeProject.isWorkspace ? '-workspace' : '-project',\n    xcodeProject.name,\n    '-configuration',\n    configuration,\n    '-scheme',\n    scheme,\n    '-destination',\n    `id=${device.udid}`,\n  ];\n\n  if (!isSimulator) {\n    const developmentTeamId = await ensureDeviceIsCodeSignedForDeploymentAsync(projectRoot);\n    if (developmentTeamId) {\n      args.push(\n        `DEVELOPMENT_TEAM=${developmentTeamId}`,\n        '-allowProvisioningUpdates',\n        '-allowProvisioningDeviceRegistration'\n      );\n    }\n  }\n\n  logPrettyItem(chalk.bold`Planning build`);\n  Log.debug(`  xcodebuild ${args.join(' ')}`);\n  const formatter = new ExpoLogFormatter({ projectRoot });\n\n  return new Promise(async (resolve, reject) => {\n    const buildProcess = spawn(\n      'xcodebuild',\n      args,\n      getProcessOptions({ packager: false, shouldSkipInitialBundling, terminal, port })\n    );\n    let buildOutput = '';\n    let errorOutput = '';\n\n    buildProcess.stdout.on('data', (data: Buffer) => {\n      const stringData = data.toString();\n      buildOutput += stringData;\n\n      const lines = formatter.pipe(stringData);\n      for (const line of lines) {\n        Log.log(line);\n      }\n    });\n\n    buildProcess.stderr.on('data', (data: Buffer) => {\n      const stringData = data instanceof Buffer ? data.toString() : data;\n      errorOutput += stringData;\n    });\n\n    buildProcess.on('close', (code: number) => {\n      formatter.finish();\n      const logFilePath = writeBuildLogs(projectRoot, buildOutput, errorOutput);\n      if (code !== 0) {\n        // Determine if the logger found any errors;\n        const wasErrorPresented = !!formatter.errors.length;\n\n        const errorTitle = `Failed to build iOS project. \"xcodebuild\" exited with error code ${code}.`;\n\n        if (wasErrorPresented) {\n          // This has a flaw, if the user is missing a file, and there is a script error, only the missing file error will be shown.\n          // They will only see the script error if they fix the missing file and rerun.\n          // The flaw can be fixed by catching script errors in the custom logger.\n          reject(new CommandError(errorTitle));\n          return;\n        }\n\n        // Show all the log info because often times the error is coming from a shell script,\n        // that invoked a node script, that started metro, which threw an error.\n        reject(\n          new CommandError(\n            `${errorTitle}\\nTo view more error logs, try building the app with Xcode directly, by opening ${xcodeProject.name}.\\n\\n` +\n              buildOutput +\n              '\\n\\n' +\n              errorOutput +\n              `Build logs written to ${chalk.underline(logFilePath)}`\n          )\n        );\n        return;\n      }\n      resolve(buildOutput);\n    });\n  });\n}\n\nfunction writeBuildLogs(projectRoot: string, buildOutput: string, errorOutput: string) {\n  const output =\n    '# Build output\\n\\n```log\\n' +\n    buildOutput +\n    '\\n```\\n\\n# Error output\\n\\n```log\\n' +\n    errorOutput +\n    '\\n```\\n';\n  const logFilePath = getErrorLogFilePath(projectRoot);\n\n  fs.writeFileSync(logFilePath, output);\n  return logFilePath;\n}\n\nfunction getErrorLogFilePath(projectRoot: string): string {\n  const filename = 'xcodebuild.md';\n  const folder = path.join(projectRoot, '.expo');\n  fs.ensureDirSync(folder);\n  return path.join(folder, filename);\n}\n"],"file":"XcodeBuild.js"}