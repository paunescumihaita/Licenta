{"version":3,"file":"Watchman.js","sourceRoot":"","sources":["../src/Watchman.ts"],"names":[],"mappings":";;;;;AAAA,oEAA4D;AAC5D,wDAA0B;AAC1B,0DAAiC;AACjC,gDAAwB;AAExB,yCAAsC;AAEtC,MAAM,4BAA4B,GAAG,IAAI,CAAC;AAE1C,SAAgB,mBAAmB;IACjC,OAAO,OAAO,CAAC,QAAQ,KAAK,QAAQ,CAAC;AACvC,CAAC;AAFD,kDAEC;AAEM,KAAK,UAAU,cAAc;IAClC,IAAI,CAAC,mBAAmB,EAAE,EAAE;QAC1B,OAAO;KACR;IAED,MAAM,mBAAQ,CAAC,cAAc,CAAC,UAAU,CAAC,CAAC;AAC5C,CAAC;AAND,wCAMC;AAEM,KAAK,UAAU,yBAAyB,CAAC,WAAoB;IAClE,IAAI,CAAC,mBAAmB,EAAE,EAAE;QAC1B,OAAO,IAAI,CAAC;KACb;IAED,IAAI;QACF,8BAA8B;QAC9B,IAAI;QACJ,sBAAsB;QACtB,IAAI;QACJ,MAAM,MAAM,GAAG,MAAM,uBAAuB,CAAC,WAAW,CAAC,CAAC;QAC1D,MAAM,eAAe,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC,OAAO,CAAC;QACjE,OAAO,eAAe,CAAC;KACxB;IAAC,OAAO,CAAC,EAAE;QACV,uFAAuF;QACvF,uCAAuC;QACvC,OAAO,IAAI,CAAC;KACb;AACH,CAAC;AAlBD,8DAkBC;AAED,KAAK,UAAU,uBAAuB,CAAC,WAAoB;IACzD,IAAI;QACF,OAAO,MAAM,mBAAQ,CAAC,aAAa,EAAE,EAAE,4BAA4B,CAAC,CAAC;KACtE;IAAC,OAAO,KAAK,EAAE;QACd,MAAM,aAAa,CAAC,WAAW,CAAC,CAAC;QACjC,OAAO,MAAM,mBAAQ,CACnB,aAAa,EAAE,EACf,4BAA4B,EAC5B,yDAAyD,CAC1D,CAAC;KACH;AACH,CAAC;AAED,KAAK,UAAU,aAAa,CAAC,WAAoB;IAC/C,IAAI,OAAO,CAAC,GAAG,CAAC,MAAM,IAAI,OAAO,CAAC,GAAG,CAAC,IAAI,EAAE;QAC1C,0BAA0B;QAC1B,kBAAE,CAAC,UAAU,CAAC,cAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,EAAE,GAAG,OAAO,CAAC,GAAG,CAAC,IAAI,QAAQ,CAAC,CAAC,CAAC;QAC1E,uBAAuB;QACvB,kBAAE,CAAC,UAAU,CAAC,+BAA+B,OAAO,CAAC,GAAG,CAAC,IAAI,QAAQ,CAAC,CAAC;KACxE;IACD,IAAI,OAAO,CAAC,QAAQ,KAAK,QAAQ,EAAE;QACjC,MAAM,qBAAU,CAAC,WAAW,EAAE;YAC5B,QAAQ;YACR,IAAI;YACJ,2DAA2D;SAC5D,CAAC,CAAC;KACJ;IACD,IAAI,WAAW,EAAE;QACf,MAAM,qBAAU,CAAC,UAAU,EAAE,CAAC,WAAW,EAAE,WAAW,CAAC,CAAC,CAAC;QACzD,MAAM,qBAAU,CAAC,UAAU,EAAE,CAAC,eAAe,EAAE,WAAW,CAAC,CAAC,CAAC;KAC9D;AACH,CAAC;AAED,KAAK,UAAU,aAAa;IAC1B,OAAO,MAAM,qBAAU,CAAC,UAAU,EAAE,CAAC,SAAS,CAAC,CAAC,CAAC;AACnD,CAAC","sourcesContent":["import spawnAsync, { SpawnResult } from '@expo/spawn-async';\nimport fs from 'fs-extra';\nimport pTimeout from 'p-timeout';\nimport path from 'path';\n\nimport { Binaries } from './internal';\n\nconst WAIT_FOR_WATCHMAN_VERSION_MS = 3000;\n\nexport function isPlatformSupported(): boolean {\n  return process.platform === 'darwin';\n}\n\nexport async function addToPathAsync(): Promise<void> {\n  if (!isPlatformSupported()) {\n    return;\n  }\n\n  await Binaries.addToPathAsync('watchman');\n}\n\nexport async function unblockAndGetVersionAsync(projectRoot?: string): Promise<string | null> {\n  if (!isPlatformSupported()) {\n    return null;\n  }\n\n  try {\n    // `watchman version` returns:\n    // {\n    //  \"version\": \"4.7.0\"\n    // }\n    const result = await _unblockAndVersionAsync(projectRoot);\n    const watchmanVersion = JSON.parse(result.stdout.trim()).version;\n    return watchmanVersion;\n  } catch (e) {\n    // TODO: Maybe check to make sure this is ENOENT (which means watchman isn't installed)\n    // We might want to report other errors\n    return null;\n  }\n}\n\nasync function _unblockAndVersionAsync(projectRoot?: string): Promise<SpawnResult> {\n  try {\n    return await pTimeout(_versionAsync(), WAIT_FOR_WATCHMAN_VERSION_MS);\n  } catch (error) {\n    await _unblockAsync(projectRoot);\n    return await pTimeout(\n      _versionAsync(),\n      WAIT_FOR_WATCHMAN_VERSION_MS,\n      '`watchman version` failed even after `launchctl unload`'\n    );\n  }\n}\n\nasync function _unblockAsync(projectRoot?: string): Promise<void> {\n  if (process.env.TMPDIR && process.env.USER) {\n    // XDL's copy of watchman:\n    fs.removeSync(path.join(process.env.TMPDIR, `${process.env.USER}-state`));\n    // homebrew's watchman:\n    fs.removeSync(`/usr/local/var/run/watchman/${process.env.USER}-state`);\n  }\n  if (process.platform === 'darwin') {\n    await spawnAsync('launchctl', [\n      'unload',\n      '-F',\n      '~/Library/LaunchAgents/com.github.facebook.watchman.plist',\n    ]);\n  }\n  if (projectRoot) {\n    await spawnAsync('watchman', ['watch-del', projectRoot]);\n    await spawnAsync('watchman', ['watch-project', projectRoot]);\n  }\n}\n\nasync function _versionAsync(): Promise<SpawnResult> {\n  return await spawnAsync('watchman', ['version']);\n}\n"]}