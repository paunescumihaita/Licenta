{"version":3,"file":"createBundlesAsync.js","sourceRoot":"","sources":["../../src/project/createBundlesAsync.ts"],"names":[],"mappings":";;;;;AAAA,yCAA2E;AAC3E,iDAA6D;AAC7D,kDAA0B;AAC1B,kDAA0B;AAE1B,0CAYqB;AAErB,MAAM,mBAAmB,GAAG,GAAG,CAAC;AAOhC,SAAgB,gBAAgB,CAAC,OAAqD;IACpF,MAAM,KAAK,GAAG;QACZ,CAAC,cAAc,EAAE,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC;QAClC,CAAC,kBAAkB,EAAE,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC;KAC3C,CAAC;IACF,iCAAiC;IACjC,IAAI,OAAO,CAAC,GAAG,CAAC,GAAG,EAAE;QACnB,KAAK,CAAC,IAAI,CAAC,CAAC,eAAK,CAAC,GAAG,CAAC,kBAAkB,CAAC,EAAE,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC;KAC9D;IACD,IAAI,OAAO,CAAC,OAAO,CAAC,GAAG,EAAE;QACvB,KAAK,CAAC,IAAI,CAAC,CAAC,eAAK,CAAC,GAAG,CAAC,sBAAsB,CAAC,EAAE,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,CAAC;KACtE;IAED,iBAAM,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;IACvB,iBAAM,CAAC,MAAM,CAAC,IAAI,CAAC,oBAAS,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC,CAAC;IACtD,iBAAM,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;IACvB,iBAAM,CAAC,MAAM,CAAC,IAAI,CAChB,mDAAmD,eAAK,CAAC,GAAG,CAC1D,oBAAS,CAAC,0CAA0C,CAAC,CACtD,EAAE,CACJ,CAAC;IACF,iBAAM,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;AACzB,CAAC;AAtBD,4CAsBC;AAEM,KAAK,UAAU,kBAAkB,CACtC,WAAmB,EACnB,iBAAiC,EAAE,EACnC,aAAuD;IAEvD,IAAI,CAAC,aAAa,CAAC,YAAY,EAAE;QAC/B,IAAI;YACF,MAAM,sCAA2B,CAAC;gBAChC,WAAW;gBACX,OAAO,EAAE;oBACP,aAAa,EAAE,IAAI;oBACnB,UAAU,EAAE,cAAc,CAAC,UAAU;oBACrC,MAAM,EAAE,cAAc,CAAC,MAAM;oBAC7B,KAAK,EAAE,cAAc,CAAC,UAAU;iBACjC;gBACD,OAAO,EAAE,CAAC,cAAc,CAAC,KAAK;aAC/B,CAAC,CAAC;YACH,OAAO,MAAM,wBAAwB,CAAC,WAAW,CAAC,CAAC;SACpD;gBAAS;YACR,MAAM,qCAA0B,CAAC,WAAW,CAAC,CAAC;SAC/C;KACF;IAED,MAAM,QAAQ,GAAG,+BAAsB,CACrC,kBAAS,CAAC,WAAW,EAAE,EAAE,yBAAyB,EAAE,IAAI,EAAE,CAAC,CAAC,GAAG,CAChE,CAAC;IACF,iFAAiF;IACjF,IAAI,CAAC,QAAQ,EAAE;QACb,OAAO,cAAc,CAAC,MAAM,CAAC;KAC9B;IACD,MAAM,SAAS,GAAe,CAAC,SAAS,EAAE,KAAK,CAAC,CAAC;IACjD,MAAM,CAAC,OAAO,EAAE,GAAG,CAAC,GAAG,MAAM,wBAAW,CACtC,WAAW,EACX;QACE,MAAM,EAAE,cAAc,CAAC,MAAM;QAC7B,UAAU,EAAE,cAAc,CAAC,UAAU;QACrC,MAAM,EAAE,uBAAY,CAAC,SAAS,CAAC,WAAW,CAAC;QAC3C,KAAK,EAAE,cAAc,CAAC,KAAK;KAC5B,EACD,SAAS,CAAC,GAAG,CAAC,CAAC,QAAkB,EAAE,EAAE,CAAC,CAAC;QACrC,QAAQ;QACR,UAAU,EAAE,4BAAiB,CAAC,WAAW,EAAE,QAAQ,CAAC;QACpD,GAAG,EAAE,aAAa,CAAC,GAAG;KACvB,CAAC,CAAC,CACJ,CAAC;IAEF,OAAO;QACL,OAAO;QACP,GAAG;KACJ,CAAC;AACJ,CAAC;AAlDD,gDAkDC;AAED,+CAA+C;AAC/C,KAAK,UAAU,wBAAwB,CAAC,WAAmB,EAAE,IAAsB;IACjF,MAAM,UAAU,GAAG,4BAAiB,CAAC,WAAW,CAAC,CAAC;IAClD,MAAM,UAAU,GAAG,MAAM,mBAAQ,CAAC,wBAAwB,CACxD,WAAW,EACX,UAAU,EACV,SAAS,EACT,IAAI,CACL,CAAC;IACF,MAAM,YAAY,GAAG,MAAM,mBAAQ,CAAC,0BAA0B,CAAC,WAAW,EAAE,UAAU,CAAC,CAAC;IACxF,MAAM,SAAS,GAAG,MAAM,mBAAQ,CAAC,uBAAuB,CAAC,WAAW,EAAE,UAAU,CAAC,CAAC;IAElF,iBAAM,CAAC,MAAM,CAAC,IAAI,CAAC,qBAAqB,CAAC,CAAC;IAC1C,MAAM,SAAS,GAAG,MAAM,oBAAoB,CAAC,WAAW,EAAE,UAAU,EAAE,KAAK,EAAE;QAC3E,SAAS,EAAE,gBAAgB;QAC3B,SAAS,EAAE,mBAAmB;KAC/B,CAAC,CAAC;IAEH,iBAAM,CAAC,MAAM,CAAC,IAAI,CAAC,yBAAyB,CAAC,CAAC;IAC9C,MAAM,aAAa,GAAG,MAAM,oBAAoB,CAAC,WAAW,EAAE,UAAU,EAAE,SAAS,EAAE;QACnF,SAAS,EAAE,gBAAgB;QAC3B,SAAS,EAAE,mBAAmB;KAC/B,CAAC,CAAC;IAEH,iBAAM,CAAC,MAAM,CAAC,IAAI,CAAC,sBAAsB,CAAC,CAAC;IAC3C,MAAM,YAAY,GAAG,MAAM,oBAAoB,CAAC,WAAW,EAAE,YAAY,EAAE,KAAK,EAAE;QAChF,SAAS,EAAE,gBAAgB;QAC3B,SAAS,EAAE,mBAAmB;KAC/B,CAAC,CAAC;IACH,MAAM,gBAAgB,GAAG,MAAM,oBAAoB,CAAC,WAAW,EAAE,YAAY,EAAE,SAAS,EAAE;QACxF,SAAS,EAAE,gBAAgB;QAC3B,SAAS,EAAE,mBAAmB;KAC/B,CAAC,CAAC;IAEH,iBAAM,CAAC,MAAM,CAAC,IAAI,CAAC,qBAAqB,CAAC,CAAC;IAC1C,MAAM,aAAa,GAAG,MAAM,oBAAoB,CAAC,WAAW,EAAE,SAAS,EAAE,KAAK,EAAE;QAC9E,SAAS,EAAE,gBAAgB;KAC5B,CAAC,CAAC;IACH,MAAM,iBAAiB,GAAG,MAAM,oBAAoB,CAAC,WAAW,EAAE,SAAS,EAAE,SAAS,EAAE;QACtF,SAAS,EAAE,gBAAgB;KAC5B,CAAC,CAAC;IAEH,OAAO;QACL,OAAO,EAAE,EAAE,IAAI,EAAE,aAAa,EAAE,GAAG,EAAE,gBAAgB,EAAE,MAAM,EAAE,IAAI,CAAC,KAAK,CAAC,iBAAiB,CAAC,EAAE;QAC9F,GAAG,EAAE,EAAE,IAAI,EAAE,SAAS,EAAE,GAAG,EAAE,YAAY,EAAE,MAAM,EAAE,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,EAAE;KAC/E,CAAC;AACJ,CAAC;AAED,KAAK,UAAU,oBAAoB,CACjC,WAAmB,EACnB,GAAW,EACX,QAAkB,EAClB,EAAE,SAAS,EAAE,SAAS,EAAgD;IAEtE,MAAM,OAAO,GAAG,GAAG,GAAG,aAAa,QAAQ,EAAE,CAAC;IAC9C,IAAI,QAAQ,CAAC;IAEb,IAAI;QACF,QAAQ,GAAG,MAAM,eAAK,CAAC,OAAO,CAAC;YAC7B,GAAG,EAAE,OAAO;YACZ,YAAY,EAAE,MAAM;YACpB,4DAA4D;YAC5D,+FAA+F;YAC/F,iBAAiB,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC;YACjC,KAAK,EAAE,KAAK;YACZ,cAAc,EAAE,MAAM,CAAC,EAAE,CAAC,MAAM,KAAK,GAAG;YACxC,OAAO,EAAE;gBACP,mBAAmB,EAAE,QAAQ;aAC9B;SACF,CAAC,CAAC;KACJ;IAAC,OAAO,KAAK,EAAE;QACd,IAAI,KAAK,CAAC,QAAQ,EAAE;YAClB,IAAI,KAAK,CAAC,QAAQ,CAAC,IAAI,EAAE;gBACvB,IAAI,IAAI,CAAC;gBACT,IAAI;oBACF,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;iBACxC;gBAAC,OAAO,CAAC,EAAE;oBACV,uBAAY,CAAC,QAAQ,CAAC,WAAW,EAAE,MAAM,EAAE,KAAK,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;iBACjE;gBAED,IAAI,IAAI,EAAE;oBACR,IAAI,IAAI,CAAC,OAAO,EAAE;wBAChB,uBAAY,CAAC,QAAQ,CAAC,WAAW,EAAE,MAAM,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;qBAC1D;yBAAM;wBACL,uBAAY,CAAC,QAAQ,CAAC,WAAW,EAAE,MAAM,EAAE,KAAK,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;qBACjE;iBACF;aACF;YACD,MAAM,IAAI,mBAAQ,CAChB,SAAS,EACT,gBAAgB,OAAO,6BAA6B,KAAK,CAAC,QAAQ,CAAC,MAAM,IAAI;gBAC3E,4EAA4E;gBAC5E,0FAA0F,CAC7F,CAAC;SACH;aAAM;YACL,MAAM,KAAK,CAAC;SACb;KACF;IAED,IAAI,CAAC,QAAQ,CAAC,IAAI,IAAI,CAAC,SAAS,IAAI,QAAQ,CAAC,IAAI,CAAC,MAAM,GAAG,SAAS,CAAC,EAAE;QACrE,MAAM,IAAI,mBAAQ,CAAC,SAAS,EAAE,YAAY,QAAQ,CAAC,IAAI,EAAE,CAAC,CAAC;KAC5D;IAED,OAAO,QAAQ,CAAC,IAAI,CAAC;AACvB,CAAC","sourcesContent":["import { getConfig, isLegacyImportsEnabled, Platform } from '@expo/config';\nimport { bundleAsync, BundleOutput } from '@expo/dev-server';\nimport axios from 'axios';\nimport chalk from 'chalk';\n\nimport {\n  ErrorCode,\n  learnMore,\n  Logger as logger,\n  ProjectUtils,\n  PublishOptions,\n  resolveEntryPoint,\n  startReactNativeServerAsync,\n  stopReactNativeServerAsync,\n  TableText,\n  UrlUtils,\n  XDLError,\n} from '../internal';\n\nconst MINIMUM_BUNDLE_SIZE = 500;\n\ntype PackagerOptions = {\n  dev: boolean;\n  minify: boolean;\n};\n\nexport function printBundleSizes(bundles: { android: BundleOutput; ios: BundleOutput }) {\n  const files = [\n    ['index.ios.js', bundles.ios.code],\n    ['index.android.js', bundles.android.code],\n  ];\n  // Account for inline source maps\n  if (bundles.ios.map) {\n    files.push([chalk.dim('index.ios.js.map'), bundles.ios.map]);\n  }\n  if (bundles.android.map) {\n    files.push([chalk.dim('index.android.js.map'), bundles.android.map]);\n  }\n\n  logger.global.info('');\n  logger.global.info(TableText.createFilesTable(files));\n  logger.global.info('');\n  logger.global.info(\n    `ðŸ’¡ JavaScript bundle sizes affect startup time. ${chalk.dim(\n      learnMore(`https://expo.fyi/javascript-bundle-sizes`)\n    )}`\n  );\n  logger.global.info('');\n}\n\nexport async function createBundlesAsync(\n  projectRoot: string,\n  publishOptions: PublishOptions = {},\n  bundleOptions: { dev?: boolean; useDevServer: boolean }\n): Promise<{ android: BundleOutput; ios: BundleOutput }> {\n  if (!bundleOptions.useDevServer) {\n    try {\n      await startReactNativeServerAsync({\n        projectRoot,\n        options: {\n          nonPersistent: true,\n          maxWorkers: publishOptions.maxWorkers,\n          target: publishOptions.target,\n          reset: publishOptions.resetCache,\n        },\n        verbose: !publishOptions.quiet,\n      });\n      return await fetchPublishBundlesAsync(projectRoot);\n    } finally {\n      await stopReactNativeServerAsync(projectRoot);\n    }\n  }\n\n  const isLegacy = isLegacyImportsEnabled(\n    getConfig(projectRoot, { skipSDKVersionRequirement: true }).exp\n  );\n  // If not legacy, delete the target option to prevent warnings from being thrown.\n  if (!isLegacy) {\n    delete publishOptions.target;\n  }\n  const platforms: Platform[] = ['android', 'ios'];\n  const [android, ios] = await bundleAsync(\n    projectRoot,\n    {\n      target: publishOptions.target,\n      resetCache: publishOptions.resetCache,\n      logger: ProjectUtils.getLogger(projectRoot),\n      quiet: publishOptions.quiet,\n    },\n    platforms.map((platform: Platform) => ({\n      platform,\n      entryPoint: resolveEntryPoint(projectRoot, platform),\n      dev: bundleOptions.dev,\n    }))\n  );\n\n  return {\n    android,\n    ios,\n  };\n}\n\n// Fetch iOS and Android bundles for publishing\nasync function fetchPublishBundlesAsync(projectRoot: string, opts?: PackagerOptions) {\n  const entryPoint = resolveEntryPoint(projectRoot);\n  const publishUrl = await UrlUtils.constructPublishUrlAsync(\n    projectRoot,\n    entryPoint,\n    undefined,\n    opts\n  );\n  const sourceMapUrl = await UrlUtils.constructSourceMapUrlAsync(projectRoot, entryPoint);\n  const assetsUrl = await UrlUtils.constructAssetsUrlAsync(projectRoot, entryPoint);\n\n  logger.global.info('Building iOS bundle');\n  const iosBundle = await _getForPlatformAsync(projectRoot, publishUrl, 'ios', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building Android bundle');\n  const androidBundle = await _getForPlatformAsync(projectRoot, publishUrl, 'android', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building source maps');\n  const iosSourceMap = await _getForPlatformAsync(projectRoot, sourceMapUrl, 'ios', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n  const androidSourceMap = await _getForPlatformAsync(projectRoot, sourceMapUrl, 'android', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building asset maps');\n  const iosAssetsJson = await _getForPlatformAsync(projectRoot, assetsUrl, 'ios', {\n    errorCode: 'INVALID_ASSETS',\n  });\n  const androidAssetsJson = await _getForPlatformAsync(projectRoot, assetsUrl, 'android', {\n    errorCode: 'INVALID_ASSETS',\n  });\n\n  return {\n    android: { code: androidBundle, map: androidSourceMap, assets: JSON.parse(androidAssetsJson) },\n    ios: { code: iosBundle, map: iosSourceMap, assets: JSON.parse(iosAssetsJson) },\n  };\n}\n\nasync function _getForPlatformAsync(\n  projectRoot: string,\n  url: string,\n  platform: Platform,\n  { errorCode, minLength }: { errorCode: ErrorCode; minLength?: number }\n): Promise<string> {\n  const fullUrl = `${url}&platform=${platform}`;\n  let response;\n\n  try {\n    response = await axios.request({\n      url: fullUrl,\n      responseType: 'text',\n      // Workaround for https://github.com/axios/axios/issues/907.\n      // Without transformResponse, axios will parse the body as JSON regardless of the responseType/\n      transformResponse: [data => data],\n      proxy: false,\n      validateStatus: status => status === 200,\n      headers: {\n        'Exponent-Platform': platform,\n      },\n    });\n  } catch (error) {\n    if (error.response) {\n      if (error.response.data) {\n        let body;\n        try {\n          body = JSON.parse(error.response.data);\n        } catch (e) {\n          ProjectUtils.logError(projectRoot, 'expo', error.response.data);\n        }\n\n        if (body) {\n          if (body.message) {\n            ProjectUtils.logError(projectRoot, 'expo', body.message);\n          } else {\n            ProjectUtils.logError(projectRoot, 'expo', error.response.data);\n          }\n        }\n      }\n      throw new XDLError(\n        errorCode,\n        `Packager URL ${fullUrl} returned unexpected code ${error.response.status}. ` +\n          'Please open your project in the Expo app and see if there are any errors. ' +\n          'Also scroll up and make sure there were no errors or warnings when opening your project.'\n      );\n    } else {\n      throw error;\n    }\n  }\n\n  if (!response.data || (minLength && response.data.length < minLength)) {\n    throw new XDLError(errorCode, `Body is: ${response.data}`);\n  }\n\n  return response.data;\n}\n"]}